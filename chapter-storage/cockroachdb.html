
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>CockroachDB Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../chapter-protocol/" />
    
    
    <link rel="prev" href="create_database.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../chapter-sentry/">
            
                <a href="../chapter-sentry/">
            
                    
                    Keycloak Sentry integration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="./">
            
                <a href="./">
            
                    
                    Keycloak Storage
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="create_database.html">
            
                <a href="create_database.html">
            
                    
                    Creating the database structure in Keycloak
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.3.2" data-path="cockroachdb.html">
            
                <a href="cockroachdb.html">
            
                    
                    CockroachDB
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../chapter-protocol/">
            
                <a href="../chapter-protocol/">
            
                    
                    Keycloak Protocol
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../chapter-protocol/general_principals.html">
            
                <a href="../chapter-protocol/general_principals.html">
            
                    
                    General principals
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../chapter-protocol/ws-fed.html">
            
                <a href="../chapter-protocol/ws-fed.html">
            
                    
                    Implementation of WS-FED
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../chapter-deploy/README.md">
            
                <span>
            
                    
                    Deployment
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../chapter-deploy/Introduction.html">
            
                <a href="../chapter-deploy/Introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../chapter-deploy/Docker.html">
            
                <a href="../chapter-deploy/Docker.html">
            
                    
                    Docker
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="../chapter-deploy/Kubernetes.html">
            
                <a href="../chapter-deploy/Kubernetes.html">
            
                    
                    Kubernetes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="../chapter-deploy/Systemd_In_Kubernetes.html">
            
                <a href="../chapter-deploy/Systemd_In_Kubernetes.html">
            
                    
                    Systemd In Kubernetes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="../chapter-deploy/Ansible.html">
            
                <a href="../chapter-deploy/Ansible.html">
            
                    
                    Ansible
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../chapter-godevel/">
            
                <a href="../chapter-godevel/">
            
                    
                    Go Development
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../chapter-godevel/structure.html">
            
                <a href="../chapter-godevel/structure.html">
            
                    
                    Repository Structure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../chapter-godevel/testing.html">
            
                <a href="../chapter-godevel/testing.html">
            
                    
                    Testing with mocks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../chapter-godevel/logging.html">
            
                <a href="../chapter-godevel/logging.html">
            
                    
                    Logging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="../chapter-godevel/instrumenting.html">
            
                <a href="../chapter-godevel/instrumenting.html">
            
                    
                    Instrumenting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="../chapter-godevel/tracing.html">
            
                <a href="../chapter-godevel/tracing.html">
            
                    
                    Tracing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="../chapter-godevel/tracking.html">
            
                <a href="../chapter-godevel/tracking.html">
            
                    
                    Tracking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="../chapter-godevel/debugging.html">
            
                <a href="../chapter-godevel/debugging.html">
            
                    
                    Debugging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.8" data-path="../chapter-godevel/middleware.html">
            
                <a href="../chapter-godevel/middleware.html">
            
                    
                    Middlewares
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >CockroachDB</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="cockroachdb">CockroachDB</h1>
<p>In this chapter we will discuss the methods with which support for CockroachDB was added to Keycloak.</p>
<h2 id="database-schema-creation">Database schema creation</h2>
<p>Keycloak uses Liquibase to create the database schema and all constants (see <a href="create_database.html">Creating the database</a>).  Liquibase supports PostgreSQL, but not directly CockroachDB. However, since CockroachDB uses the PostgreSQL jdbc driver and supports the syntax, Liquibase is mostly compable with CockroachDB.</p>
<p>However, there are quite a few notable exceptions to this compatibility, and they arise when Keycloak&apos;s &quot;normal&quot; database changelogs are used. To correct the problem, a new set of changelogs specifically for CockroachDB are generated, mostely using the <code>ChangeLogEditor</code> - a java tool developped specifcally for this purpose.</p>
<p>The following subsections list the incompatibilities between the Keycloak changelogs and CockroachDB, and the modifications made.</p>
<h3 id="adding-primary-keys">Adding primary keys</h3>
<p>In CockroachDB primary keys must be created with the tables and cannot be manipulated afterwards, but in the Keycloak changelogs the operation is always seperate. To correct this, the syntax is modified to group the creation of primary keys in the create table instruction.</p>
<p>However, in a few cases (about 8), &quot;primary columns&quot; are removed, and a new key is added. Since the table generation is in another file, in this case:</p>
<ol>
<li>A new table is created with the correct structure</li>
<li>The contents are copied from the old table to the new table</li>
<li>The old table is dropped</li>
<li>The new table is renamed to the correct table name. </li>
</ol>
<h3 id="adding-foreign-keys">Adding foreign keys</h3>
<p>Foreign keys can be added and removed without problem in CockroachDB, however the column(s) MUST have a index defined on it. The solution creates indexes on all columns in a new changelog (to avoid precedence problems), and moves all &quot;add foreign keys&quot; to a third column (for the same reason.</p>
<h3 id="removing-unique-constraints">Removing unique constraints</h3>
<p>In CockroachDB altering a table to add a unique constraint in fact creates a unique index, and adds an entry to the list of constraints. And in fact creating a unique index does exactly the same thing, meaning that the two are interchangable. However, while it is possible to drop a unique index (which also drops the contraint), the CockRoachDB does not allow the syntax to drop the constraint. </p>
<p>The modification changes all instances of &quot;drop unique constraint&quot; to &quot;drop uinique index&quot;.</p>
<h3 id="activities-that-must-or-should-be-done">Activities that must or should be done</h3>
<p>This TODO list can be editied as the following tasks are resolved:</p>
<ul>
<li>Only create indexes for foreign keys when one does not already exist</li>
<li>Remove indexes created for foreign keys when they are removed</li>
<li>Push a modification to CockroachDB to ensure that &quot;remove unique contraint&quot; acts like &quot;remove unique index&quot;</li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="create_database.html" class="navigation navigation-prev " aria-label="Previous page: Creating the database structure in Keycloak">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../chapter-protocol/" class="navigation navigation-next " aria-label="Next page: Keycloak Protocol">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"CockroachDB","level":"1.3.2","depth":2,"next":{"title":"Keycloak Protocol","level":"1.4","depth":1,"path":"chapter-protocol/README.md","ref":"chapter-protocol/README.md","articles":[{"title":"General principals","level":"1.4.1","depth":2,"path":"chapter-protocol/general_principals.md","ref":"chapter-protocol/general_principals.md","articles":[]},{"title":"Implementation of WS-FED","level":"1.4.2","depth":2,"path":"chapter-protocol/ws-fed.md","ref":"chapter-protocol/ws-fed.md","articles":[]}]},"previous":{"title":"Creating the database structure in Keycloak","level":"1.3.1","depth":2,"path":"chapter-storage/create_database.md","ref":"chapter-storage/create_database.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"chapter-storage/cockroachdb.md","mtime":"2018-02-01T14:49:32.562Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-02-24T12:52:49.323Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

